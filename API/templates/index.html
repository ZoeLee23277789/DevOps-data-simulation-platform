<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>TSMC è¨­å‚™ç›£æ§ Dashboard</title>
    <link href="{{ url_for('static', filename='output.css') }}" rel="stylesheet" />
</head>
<body class="bg-gray-100 p-10">
    <h1 class="text-3xl font-bold mb-6">
        <span class="mr-2">ğŸŒ¡ï¸</span>TSMC è¨­å‚™ç›£æ§ <span class="text-blue-700">Dashboard</span>
    </h1>

    <!-- ğŸ“Ÿ å³æ™‚ç›£æ§å¡ç‰‡ -->
    <div id="dashboard" class="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 mb-10"></div>

    <!-- ğŸ“ˆ æ©Ÿå™¨å£“åŠ› -->
    <div class="w-full mb-8">
        <h2 class="text-2xl font-bold mb-4">ğŸ“Š å£“åŠ›æ­·å²è¶¨å‹¢åœ–</h2>
        <iframe src="http://localhost:3000/d-solo/behkyp3yzzhtsf/e5a393-e58a9b-e79ba3-e68ea7-machine-pressure?orgId=1&from=now-5m&to=now&refresh=10s&theme=dark&panelId=1"
                width="100%" height="300" frameborder="0"></iframe>
    </div>

    <!-- ğŸŒ¡ï¸ æ©Ÿå™¨æº«åº¦ -->
    <div class="w-full mb-8">
        <h2 class="text-2xl font-bold mb-4">ğŸŒ¡ï¸ æº«åº¦æ­·å²è¶¨å‹¢åœ–</h2>
        <iframe src="http://localhost:3000/d-solo/eehkyjpkkytxca/e6baab-e5baa6-e79ba3-e68ea7-machine-temperature?orgId=1&from=now-5m&to=now&refresh=10s&theme=dark&panelId=1"
                width="100%" height="300" frameborder="0"></iframe>
    </div>


    <!-- ğŸ’» JS å³æ™‚æ›´æ–° -->
    <script>
        async function fetchData() {
            try {
                const res = await fetch("/get_latest_per_machine");
                const json = await res.json();

                // æ’åº
                json.sort((a, b) => {
                    const numA = parseInt(a.machine_id.replace("TSMC-M", ""));
                    const numB = parseInt(b.machine_id.replace("TSMC-M", ""));
                    return numA - numB;
                });

                const dashboard = document.getElementById("dashboard");
                dashboard.innerHTML = "";

                json.forEach(item => {
                    const isOverTemp = item.temperature > 90;
                    const isOverPressure = item.pressure > 2.4;

                    const card = document.createElement("div");
                    card.className = "p-6 rounded-2xl shadow-md text-black";
                    card.style.backgroundColor = isOverTemp || isOverPressure ? "#fecaca" : "#ffffff";
                    card.style.border = isOverTemp || isOverPressure ? "2px solid #ef4444" : "none";

                    card.innerHTML = `
                                <h2 class="text-xl font-semibold mb-2">${item.machine_id}</h2>
                                <p>ğŸŒ¡ï¸ æº«åº¦ï¼š${item.temperature} Â°C</p>
                                <p>ğŸ§¯ å£“åŠ›ï¼š${item.pressure} bar</p>
                                <p>â±ï¸ æ™‚é–“ï¼š${new Date(item.timestamp).toLocaleString()}</p>
                            `;
                    dashboard.appendChild(card);
                });
            } catch (err) {
                console.error("âŒ Error:", err);
            }
        }

        fetchData();
        setInterval(fetchData, 5000);
    </script>
</body>
</html>
