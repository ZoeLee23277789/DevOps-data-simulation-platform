<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>TSMC è¨­å‚™ç›£æ§ Dashboard</title>
    <link href="{{ url_for('static', filename='output.css') }}" rel="stylesheet" />
</head>
<body class="bg-gray-100 p-10">
    <h1 class="text-3xl font-bold mb-6">
        <span class="mr-2">ğŸŒ¡ï¸</span>TSMC è¨­å‚™ç›£æ§ <span class="text-blue-700">Dashboard</span>
    </h1>

    <!-- å‹•æ…‹å„€è¡¨æ¿å€å¡Š -->
    <div id="dashboard" class="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 mb-10"></div>

    <!-- åµŒå…¥ Grafana Dashboard -->
    <div class="w-full">
        <h2 class="text-2xl font-bold mb-4">ğŸ“Š æ­·å²è¶¨å‹¢åœ– (Grafana)</h2>
        <iframe src="http://localhost:3000/d/your-dashboard-uid/tsmc-dashboard?orgId=1&refresh=5s"
                width="100%" height="600" frameborder="0"></iframe>
    </div>

    <script>
        async function fetchData() {
            try {
                const res = await fetch("/get_latest_per_machine");
                const json = await res.json();

                // æ’åºï¼šä¾æ“šæ©Ÿå™¨ ID æ•¸å­—
                json.sort((a, b) => {
                    const numA = parseInt(a.machine_id.replace("TSMC-M", ""));
                    const numB = parseInt(b.machine_id.replace("TSMC-M", ""));
                    return numA - numB;
                });

                const dashboard = document.getElementById("dashboard");
                dashboard.innerHTML = "";

                json.forEach(item => {
                    const isOverTemp = item.temperature > 90;
                    const isOverPressure = item.pressure > 2.4;

                    const card = document.createElement("div");
                    card.className = "p-6 rounded-2xl shadow-md text-black";
                    card.style.backgroundColor = isOverTemp || isOverPressure ? "#fecaca" : "#ffffff"; // bg-red-200
                    card.style.border = isOverTemp || isOverPressure ? "2px solid #ef4444" : "none";  // border-red-500

                    card.innerHTML = `
                            <h2 class="text-xl font-semibold mb-2">${item.machine_id}</h2>
                            <p>ğŸŒ¡ï¸ æº«åº¦ï¼š${item.temperature} Â°C</p>
                            <p>ğŸ§¯ å£“åŠ›ï¼š${item.pressure} bar</p>
                            <p>â±ï¸ æ™‚é–“ï¼š${new Date(item.timestamp).toLocaleString()}</p>
                        `;
                    dashboard.appendChild(card);
                });
            } catch (err) {
                console.error("âŒ Error:", err);
            }
        }

        fetchData();
        setInterval(fetchData, 5000);
    </script>
</body>
</html>